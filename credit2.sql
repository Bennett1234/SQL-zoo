/*
1. How many SL/TL/PL loans did we make last week for each state?
*/
SELECT B.BRANCH_STATE,
       SUM(CASE
               WHEN P.PRODUCT_CATEGORY = 124005
               THEN 1
               ELSE 0
           END) AS WEEKLY_COUNTS_SL,
       SUM(CASE
               WHEN P.PRODUCT_CATEGORY = 124001
               THEN 1
               ELSE 0
           END) AS WEEKLY_COUNTS_TL,
       SUM(CASE
               WHEN P.PRODUCT_CATEGORY = 124002
               THEN 1
               ELSE 0
           END) AS WEEKLY_COUNTS_PL
FROM ODS.ACCOUNT_INFO AS AI JOIN ODS.DW_BRANCH_DIM AS B ON (AI.SERVICER_PARTY_ID = B.BRANCH_PARTY_ID)
                            JOIN ELMS.PRODUCT AS P ON(P.PRODUCT_ID = AI.PRODUCT_ID)
WHERE AI.ORIG_DATE BETWEEN '2018-10-22' AND '2018-10-28' AND AI.LOAN_STATUS_ID NOT IN (23002,23004)
GROUP BY B.BRANCH_STATE

/*
2. How mach principal did we give for SL/TL/PL last week for each state?
*/
SELECT B.BRANCH_STATE, 
 SUM(CASE
         WHEN P.PRODUCT_CATEGORY = 124005
         THEN AI.AMOUNT_GIVEN_DIRECT
         ELSE 0
      END) AS WEEKLY_SUM_SL,
 SUM(CASE
         WHEN P.PRODUCT_CATEGORY = 124001
         THEN AI.AMOUNT_GIVEN_DIRECT
         ELSE 0
     END) AS WEEKLY_SUM_TL,
SUM(CASE
        WHEN P.PRODUCT_CATEGORY = 124002
        THEN AI.AMOUNT_GIVEN_DIRECT
        ELSE 0
     END) AS WEEKLY_SUM_PL
 FROM ODS.ACCOUNT_INFO AS AI JOIN ODS.DW_BRANCH_DIM AS B ON (AI.SERVICER_PARTY_ID = B.BRANCH_PARTY_ID)
                             JOIN ELMS.PRODUCT AS P ON (P.PRODUCT_ID = AI.PRODUCT_ID)
 WHERE AI.ORIG_DATE BETWEEN '2018-10-22' AND '2018-10-28' AND AI.LOAN_STATUS_ID NOT IN (23002,23004)
 GROUP BY B.BRANCH_STATE
 
 /*
 3. How much payment did we receive from CA SL customer on last Friday(2018-09-14).
 */
 SELECT SUM(FAI.FUNDS_AMOUNT) AS SUM_PAYMENT
FROM ODS.ACCOUNT_INFO AS AI JOIN ODS.DW_BRANCH_DIM AS B ON (AI.SERVICER_PARTY_ID =B.BRANCH_PARTY_ID)
                            JOIN ODS.FIN_ACTIVITY_INFO AS FAI ON (FAI.ACCOUNT_ID = AI.ACCOUNT_ID)
                            JOIN ELMS.PRODUCT AS P ON (P.PRODUCT_ID = AI.PRODUCT_ID)
WHERE B.BRANCH_STATE = 'CA' AND FAI.CREATE_DT BETWEEN '2018-09-14 00:00:00' AND '2018-09-14 23:59:59'
AND FAI.TRANSACTION_TYPE_ID IN (1006,1014,1027,1022,1021,1010,1025,1028,1024,1023,1007,1016,1017,1034,1019,1013,1032,1009,1011,1026,1020,1012,1064,4010,4003,5012)
AND P.PRODUCT_CATEGORY = 124005

/*
4. Among all the payments from CA last Friday, how much payment went into principal and how much into the interest?
*/
SELECT SUM(CASE
               WHEN FAI.FUNDS_AMOUNT >= FAI.INTEREST
               THEN FAI.INTEREST
               ELSE FAI.FUNDS_AMOUNT
           END) AS SUM_INTEREST,
       SUM(CASE
               WHEN FAI.FUNDS_AMOUNT <= FAI.INTEREST
               THEN 0
               ELSE FAI.FUNDS_AMOUNT - FAI.INTEREST
           END) AS SUM_PRINCIPAL
FROM ODS.ACCOUNT_INFO AS AI JOIN ODS.DW_BRANCH_DIM AS B ON (AI.SERVICER_PARTY_ID =B.BRANCH_PARTY_ID)
                            JOIN ODS.FIN_ACTIVITY_INFO AS FAI ON (FAI.ACCOUNT_ID = AI.ACCOUNT_ID)
                            JOIN ELMS.PRODUCT AS P ON (P.PRODUCT_ID = AI.PRODUCT_ID)
WHERE (B.BRANCH_STATE = 'CA' AND FAI.CREATE_DT BETWEEN '2018-09-14 00:00:00' AND '2018-09-14 23:59:59' AND FAI.FUNDS_AMOUNT > 0
AND FAI.TRANSACTION_TYPE_ID IN (1006,1014,1027,1022,1021,1010,1025,1028,1024,1023,1007,1016,1017,1034,1019,1013,1032,1009,1011,1026,1020,1012,1064,4010,4003,5012)
AND P.PRODUCT_CATEGORY = 124005) 

/*
5. For SL, today how many accounts are late(days_late > 0).
*/
SELECT COUNT(*)
FROM ODS.ACCOUNT_INFO AS AI JOIN ELMS.PRODUCT AS P ON (AI.PRODUCT_ID = P.PRODUCT_ID)
WHERE P.PRODUCT_CATEGORY = 124005 AND DAYS(CURRENT_DATE) - DAYS(AI.NEXT_DUE_DATE) > 0
AND AI.LOAN_STATUS = 'Active'
